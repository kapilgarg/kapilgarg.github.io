<!DOCTYPE html>
<html lang="en">
<head>

    <title>How to process nested arrays in json with Athena.</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css?v=776d70e7aa" />

    <link rel="canonical" href="https://kapilgarg.github.io/process-nested-array-in-athena/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="https://kapilgarg.github.io/process-nested-array-in-athena/amp/" />
    
    <meta property="og:site_name" content="basic function" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="How to process nested arrays in json with Athena." />
    <meta property="og:description" content="Suppose you are writing an application for a library. Instead of storing book inventory in traditional db, you decided to use s3. Each book record is converted to json, stringified, written to a file and stored in S3 as an object. To read this, you create tables in Athena and" />
    <meta property="og:url" content="https://kapilgarg.github.io/process-nested-array-in-athena/" />
    <meta property="og:image" content="https://kapilgarg.github.io/content/images/2020/08/lenin-estrada-OI1ToozsKBw-unsplash.jpg" />
    <meta property="article:published_time" content="2020-08-20T09:09:35.000Z" />
    <meta property="article:modified_time" content="2020-08-20T09:11:34.000Z" />
    <meta property="article:tag" content="aws" />
    <meta property="article:tag" content="athena" />
    <meta property="article:tag" content="nestedarray" />
    <meta property="article:tag" content="unnest" />
    <meta property="article:tag" content="json" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="How to process nested arrays in json with Athena." />
    <meta name="twitter:description" content="Suppose you are writing an application for a library. Instead of storing book inventory in traditional db, you decided to use s3. Each book record is converted to json, stringified, written to a file and stored in S3 as an object. To read this, you create tables in Athena and" />
    <meta name="twitter:url" content="https://kapilgarg.github.io/process-nested-array-in-athena/" />
    <meta name="twitter:image" content="https://kapilgarg.github.io/content/images/2020/08/lenin-estrada-OI1ToozsKBw-unsplash.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="KAPIL" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="aws, athena, nestedarray, unnest, json" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "basic function",
        "url": "https://kapilgarg.github.io/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://kapilgarg.github.io/favicon.ico",
            "width": 48,
            "height": 48
        }
    },
    "author": {
        "@type": "Person",
        "name": "KAPIL",
        "url": "https://kapilgarg.github.io/author/kapil-2/",
        "sameAs": []
    },
    "headline": "How to process nested arrays in json with Athena.",
    "url": "https://kapilgarg.github.io/process-nested-array-in-athena/",
    "datePublished": "2020-08-20T09:09:35.000Z",
    "dateModified": "2020-08-20T09:11:34.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://kapilgarg.github.io/content/images/2020/08/lenin-estrada-OI1ToozsKBw-unsplash.jpg"
    },
    "keywords": "aws, athena, nestedarray, unnest, json",
    "description": "Suppose you are writing an application for a library. Instead of storing book inventory in traditional db, you decided to use s3. Each book record is converted to json, stringified, written to a file and stored in S3 as an object. To read this, you create tables in Athena and write SQL queries to fetch the data.\n\n{\n\t&#x27;name&#x27;:&#x27;my-book-name&#x27;,\n    \t&#x27;ISBN&#x27;:123456,\n    \t&#x27;publisher&#x27;:&#x27;the-one&#x27;,\n    \t&#x27;publication-date&#x27;:&#x27;&#x27;,\n\t...\n}\n\n\n\n\nName\n\n\nISBN\n\n\npublisher\n\n\npublication-date\n\n\n\n\nmy-book1\n\n\n123456\n\n\nthe-o",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://kapilgarg.github.io/"
    }
}
    </script>

    <meta name="generator" content="Ghost 5.1" />
    <link rel="alternate" type="application/rss+xml" title="basic function" href="https://kapilgarg.github.io/rss/" />
    <script defer src="https://unpkg.com/@tryghost/portal@~2.1.0/umd/portal.min.js" data-ghost="https://kapilgarg.github.io/" data-key="6411187770ec86e91904481ed3" data-api="https://kapilgarg.github.io/ghost/api/content/" crossorigin="anonymous"></script><style id="gh-members-styles">.gh-post-upgrade-cta-content,
.gh-post-upgrade-cta {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    text-align: center;
    width: 100%;
    color: #ffffff;
    font-size: 16px;
}

.gh-post-upgrade-cta-content {
    border-radius: 8px;
    padding: 40px 4vw;
}

.gh-post-upgrade-cta h2 {
    color: #ffffff;
    font-size: 28px;
    letter-spacing: -0.2px;
    margin: 0;
    padding: 0;
}

.gh-post-upgrade-cta p {
    margin: 20px 0 0;
    padding: 0;
}

.gh-post-upgrade-cta small {
    font-size: 16px;
    letter-spacing: -0.2px;
}

.gh-post-upgrade-cta a {
    color: #ffffff;
    cursor: pointer;
    font-weight: 500;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a:hover {
    color: #ffffff;
    opacity: 0.8;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a.gh-btn {
    display: block;
    background: #ffffff;
    text-decoration: none;
    margin: 28px 0 0;
    padding: 8px 18px;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
}

.gh-post-upgrade-cta a.gh-btn:hover {
    opacity: 0.92;
}</style><style>:root {--ghost-accent-color: #15171A;}</style>
    <!-- link tag -->

</head>
<body class="post-template tag-aws tag-athena tag-nestedarray tag-unnest tag-json has-cover">
<div class="viewport">

    <header id="gh-head" class="gh-head outer">
        <nav class="gh-head-inner inner">

            <div class="gh-head-brand">
                <a class="gh-head-logo no-image" href="https://kapilgarg.github.io">
                        basic function
                </a>
                <a class="gh-burger" role="button">
                    <div class="gh-burger-box">
                        <div class="gh-burger-inner"></div>
                    </div>
                </a>
            </div>
            <div class="gh-head-menu">
                <ul class="nav">
    <li class="nav-home"><a href="https://kapilgarg.github.io/">Home</a></li>
</ul>

            </div>
            <div class="gh-head-actions">
                <div class="gh-social">
                </div>
                        <a class="gh-head-button" href="#/portal/signup" data-portal="signup">Subscribe</a>
            </div>
        </nav>
    </header>

    <div class="site-content">
        



<main id="site-main" class="site-main">
<article class="article post tag-aws tag-athena tag-nestedarray tag-unnest tag-json ">

    <header class="article-header gh-canvas">

        <div class="article-tag post-card-tags">
                <span class="post-card-primary-tag">
                    <a href="/tag/aws/">aws</a>
                </span>
        </div>

        <h1 class="article-title">How to process nested arrays in json with Athena.</h1>


        <div class="article-byline">
        <section class="article-byline-content">

            <ul class="author-list">
                <li class="author-list-item">
                    <a href="/author/kapil-2/" class="author-avatar author-profile-image"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg>
</a>
                </li>
            </ul>

            <div class="article-byline-meta">
                <h4 class="author-name"><a href="/author/kapil-2/">KAPIL</a></h4>
                <div class="byline-meta-content">
                    <time class="byline-meta-date" datetime="2020-08-20">Aug 20, 2020</time>
                        <span class="byline-reading-time"><span class="bull">&bull;</span> 3 min read</span>
                </div>
            </div>

        </section>
        </div>

            <figure class="article-image">
                <img
                    srcset="/content/images/size/w300/2020/08/lenin-estrada-OI1ToozsKBw-unsplash.jpg 300w,
                            /content/images/size/w600/2020/08/lenin-estrada-OI1ToozsKBw-unsplash.jpg 600w,
                            /content/images/size/w1000/2020/08/lenin-estrada-OI1ToozsKBw-unsplash.jpg 1000w,
                            /content/images/size/w2000/2020/08/lenin-estrada-OI1ToozsKBw-unsplash.jpg 2000w"
                    sizes="(min-width: 1400px) 1400px, 92vw"
                    src="/content/images/size/w2000/2020/08/lenin-estrada-OI1ToozsKBw-unsplash.jpg"
                    alt="How to process nested arrays in json with Athena."
                />
            </figure>

    </header>

    <section class="gh-content gh-canvas">
        <p>Suppose you are writing an application for a library. Instead of storing book inventory in traditional db, you decided to use s3. Each book record is converted to json, stringified, written to a file and stored in S3 as an object. To read this, you create tables in Athena and write SQL queries to fetch the data. </p><pre><code class="language-json">{
	'name':'my-book-name',
    	'ISBN':123456,
    	'publisher':'the-one',
    	'publication-date':'',
	...
}</code></pre><!--kg-card-begin: html--><table>
    <tr>
        <th>
            Name
        </th>
        <th>
            ISBN
        </th>
        <th>
            publisher
        </th>
        <th>
            publication-date
        </th>
    </tr>
    <tr>
        <td>
            my-book1
        </td>
        <td>
            123456
        </td>
        <td>
            the-one
        </td>
        <td>
            1-1-2020
        </td>
</table><!--kg-card-end: html--><p>But you realized that the JSON is not a flat structure. It consist of nested objects.</p><pre><code>{
	'name':'my-book-name',
    	'ISBN':123456,
    	'publisher':'the-one',
    	'publication-date':'',
	'authors':[{'id':1,'name':'author-1'},{'id':2,'name':'author-2'}]
}</code></pre><p>You can't store this JSON in a simple table because field '<em>authors</em>' contains an array of objects and you can not directly query author id and author name.</p><p>There are two problems with <em>authors</em> field.</p><ol><li>It is an array.</li><li>Each item in array is an object having multiple properties.</li></ol><p>To solve the first problem, we need to flatten the array into multiple rows.  For the given record, after flattening, it would create two records since there are two authors for the book.</p><pre><code>{
	'name':'my-book-name',
    	'ISBN':123456,
    	'publisher':'the-one',
    	'publication-date':'',
	'author':{'id':1,'name':'author-1'}
}
{
	'name':'my-book-name',
    	'ISBN':123456,
    	'publisher':'the-one',
    	'publication-date':'',
	'author':{'id':2,'name':'author-2'}
}</code></pre><p>For 2nd problem, once we have converted array in multiple rows, we can access individual property  from each row (author).</p><p>To convert authors array in multiple records, we don't need to change the way we store data although you can split book JSON into two and move authors into a separate JSON. But here we are keeping the base data as it is and creating the view on top of it which gives us access to author object and its properties.</p><p>This is the table which contains the data in JSON without any change.</p><!--kg-card-begin: html--><table>
    <tr>
        <th>
            Name
        </th>
        <th>
            ISBN
        </th>
        <th>
            publisher
        </th>
        <th>
            publication-date
        </th>
        <th>
            authors
        </th>
    </tr>
    <tr>
        <td>
            my-book1
        </td>
        <td>
            123456
        </td>
        <td>
            the-one
        </td>
        <td>
            1-1-2020
        </td>
        <td>
        [{'id':1,'name':'author-1'},{'id':2,'name':'author-2'}]
        </td>
    </tr>
</table><!--kg-card-end: html--><p>What we want is a view on top of this that provides all the fields.</p><!--kg-card-begin: html--><table>
    <tr>
        <th>
            Name
        </th>
        <th>
            ISBN
        </th>
        <th>
            publisher
        </th>
        <th>
            publication-date
        </th>
        <th>
            author-id
        </th>
        <th>
            author-name
        </th>
    </tr>
    <tr>
        <td>
            my-book1
        </td>
        <td>
            123456
        </td>
        <td>
            the-one
        </td>
        <td>
            1-1-2020
        </td>
        <td>
            1
        </td>
        <td>
            author-1
        </td>
        
    </tr>
    <tr>
        <td>
            my-book1
        </td>
        <td>
            123456
        </td>
        <td>
            the-one
        </td>
        <td>
            1-1-2020
        </td>
        <td>
            2
        </td>
        <td>
            author-2
        </td>
        
    </tr>
</table><!--kg-card-end: html--><p>To achieve this, we can use <strong>UNNEST </strong>function which converts an array to multiple rows. </p><p>a simple Athena query to create a view  -</p><pre><code class="language-T sql">CREATE OR REPLACE VIEW vBook AS 
    --[1]
    WITH dataset as (
    SELECT '123456' as ISBN, 'my-book-name' as name, 'the-one' as publisher, '1-1-2020' as publication_date, 
    JSON '[{"id":"1","name":"auth-1"},{"id":"2","name":"auth-2"}]' as authors )

    --[2]
    SELECT ISBN,name,publisher,publication_date,author['id'] as author_id,author['name'] as author_name from (

    --[3]
        SELECT ISBN,name,publisher,publication_date,CAST(authors as ARRAY(MAP(varchar,varchar))) as authors from dataset)

    CROSS JOIN UNNEST(authors) as t(author)</code></pre><p>[1]First we fetch the data from <em>table </em>as per the criteria and storing in <em>dataset</em></p><p>[3]Now in the internal select statement, we select all the columns we need and also convert JSON to an array of map.</p><p>[2]this is the final select statement where we UNNEST the authors(array)  as author and select fields required.</p><p>Now you can run your query on this view </p><pre><code class="language-sql">SELECT 	* from vBook</code></pre><p>result-</p><figure class="kg-card kg-image-card"><img src="https://kapilgarg.github.io/content/images/2020/08/image-4.png" class="kg-image" alt loading="lazy" width="1382" height="301" srcset="https://kapilgarg.github.io/content/images/size/w600/2020/08/image-4.png 600w, https://kapilgarg.github.io/content/images/size/w1000/2020/08/image-4.png 1000w, https://kapilgarg.github.io/content/images/2020/08/image-4.png 1382w" sizes="(min-width: 720px) 720px"></figure><p>This is one of the solution to handle nested json and not the only solution. You should always check the data size, partition, performance and decide on the the solution.</p><p>happy coding ...</p>
    </section>


</article>
</main>

    <section class="footer-cta outer">
        <div class="inner">
            <h2 class="footer-cta-title">Sign up for more like this.</h2>
            <a class="footer-cta-button" href="#/portal" data-portal>
                <div class="footer-cta-input">Enter your email</div>
                <span>Subscribe</span>
            </a>
        </div>
    </section>



            <aside class="read-more-wrap outer">
                <div class="read-more inner">
                        
<article class="post-card post post-access-public">

    <a class="post-card-image-link" href="/coming-soon/">

        <img class="post-card-image"
            srcset="https://static.ghost.org/v4.0.0/images/feature-image.jpg 300w,
                    https://static.ghost.org/v4.0.0/images/feature-image.jpg 600w,
                    https://static.ghost.org/v4.0.0/images/feature-image.jpg 1000w,
                    https://static.ghost.org/v4.0.0/images/feature-image.jpg 2000w"
            sizes="(max-width: 1000px) 400px, 800px"
            src="https://static.ghost.org/v4.0.0/images/feature-image.jpg"
            alt="Coming soon"
            loading="lazy"
        />


    </a>

    <div class="post-card-content">

        <a class="post-card-content-link" href="/coming-soon/">
            <header class="post-card-header">
                <div class="post-card-tags">
                </div>
                <h2 class="post-card-title">
                    Coming soon
                </h2>
            </header>
                <div class="post-card-excerpt">This is basic function, a brand new site by kapil that's just getting started. Things will be up and running here shortly, but you can subscribe in the meantime if you'd like to stay up to date and receive emails when new content is published!</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2022-05-30">May 30, 2022</time>
        </footer>

    </div>

</article>
                        
<article class="post-card post featured no-image post-access-public">


    <div class="post-card-content">

        <a class="post-card-content-link" href="/mock-environment-variable-in-unittest/">
            <header class="post-card-header">
                <div class="post-card-tags">
                        <span class="post-card-featured"><svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M4.49365 4.58752C3.53115 6.03752 2.74365 7.70002 2.74365 9.25002C2.74365 10.6424 3.29678 11.9778 4.28134 12.9623C5.26591 13.9469 6.60127 14.5 7.99365 14.5C9.38604 14.5 10.7214 13.9469 11.706 12.9623C12.6905 11.9778 13.2437 10.6424 13.2437 9.25002C13.2437 6.00002 10.9937 3.50002 9.16865 1.68127L6.99365 6.25002L4.49365 4.58752Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
</svg> Featured</span>
                </div>
                <h2 class="post-card-title">
                    Mock environment variable in unittest
                </h2>
            </header>
                <div class="post-card-excerpt">While writing test cases, you may need to mock one or more environment variables. It could be because environment variable it used as a flag for certain functionality or something else.

Environment variables are available through os.environ api. Though technically os.environ [1] is not a dictionary but it</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2022-03-08">Mar 8, 2022</time>
                <span class="sep">—</span>
                <span class="post-card-meta-length">2 min read</span>
        </footer>

    </div>

</article>
                        
<article class="post-card post no-image post-access-public">


    <div class="post-card-content">

        <a class="post-card-content-link" href="/write-a-file-watcher-and-read-the-delta/">
            <header class="post-card-header">
                <div class="post-card-tags">
                </div>
                <h2 class="post-card-title">
                    Write a file-watcher and read the delta...
                </h2>
            </header>
                <div class="post-card-excerpt">While working on an on-premise compute grid, there was a need to monitor the status of various jobs running on worker nodes. There is a scheduler which assign tasks to worker nodes and maintains the status of each job. As a job moves through various stages of its life cycle,</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2022-02-20">Feb 20, 2022</time>
                <span class="sep">—</span>
                <span class="post-card-meta-length">1 min read</span>
        </footer>

    </div>

</article>
                </div>
            </aside>



    </div>

    <footer class="site-footer outer">
        <div class="inner">
            <section class="copyright"><a href="https://kapilgarg.github.io">basic function</a> &copy; 2022</section>
            <nav class="site-footer-nav">
                
            </nav>
            <div><a href="https://ghost.org/" target="_blank" rel="noopener">Powered by Ghost</a></div>
        </div>
    </footer>

</div>


<script
    src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous">
</script>
<script src="/assets/built/casper.js?v=776d70e7aa"></script>
<script>
$(document).ready(function () {
    // Mobile Menu Trigger
    $('.gh-burger').click(function () {
        $('body').toggleClass('gh-head-open');
    });
    // FitVids - Makes video embeds responsive
    $(".gh-content").fitVids();
});
</script>

<!-- script tag -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-169335725-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-169335725-1');
</script>

</body>
</html>
