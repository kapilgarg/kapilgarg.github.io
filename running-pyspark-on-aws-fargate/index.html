<!DOCTYPE html>
<html lang="en">
<head>

    <title>Pyspark on AWS Fargate</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css?v=776d70e7aa" />

    <link rel="canonical" href="https://kapilgarg.github.io/running-pyspark-on-aws-fargate/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="https://kapilgarg.github.io/running-pyspark-on-aws-fargate/amp/" />
    
    <meta property="og:site_name" content="basic function" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Pyspark on AWS Fargate" />
    <meta property="og:description" content="I&#x27;m using AWS Batch to run a few pyspark batch jobs and many times, when a job is submitted, it takes a few minutes to start the job. This delay may range from 2-15 minutes depending on the availability of EC2 machine and on the configuration provided. This is something" />
    <meta property="og:url" content="https://kapilgarg.github.io/running-pyspark-on-aws-fargate/" />
    <meta property="og:image" content="https://kapilgarg.github.io/content/images/2021/01/pexels-freestocksorg-457713.jpg" />
    <meta property="article:published_time" content="2021-01-17T11:30:50.000Z" />
    <meta property="article:modified_time" content="2021-01-17T11:30:50.000Z" />
    <meta property="article:tag" content="pyspark" />
    <meta property="article:tag" content="aws-sdk" />
    <meta property="article:tag" content="hadoop" />
    <meta property="article:tag" content="fargate" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Pyspark on AWS Fargate" />
    <meta name="twitter:description" content="I&#x27;m using AWS Batch to run a few pyspark batch jobs and many times, when a job is submitted, it takes a few minutes to start the job. This delay may range from 2-15 minutes depending on the availability of EC2 machine and on the configuration provided. This is something" />
    <meta name="twitter:url" content="https://kapilgarg.github.io/running-pyspark-on-aws-fargate/" />
    <meta name="twitter:image" content="https://kapilgarg.github.io/content/images/2021/01/pexels-freestocksorg-457713.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="KAPIL" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="pyspark, aws-sdk, hadoop, fargate" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "basic function",
        "url": "https://kapilgarg.github.io/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://kapilgarg.github.io/favicon.ico",
            "width": 48,
            "height": 48
        }
    },
    "author": {
        "@type": "Person",
        "name": "KAPIL",
        "url": "https://kapilgarg.github.io/author/kapil-2/",
        "sameAs": []
    },
    "headline": "Pyspark on AWS Fargate",
    "url": "https://kapilgarg.github.io/running-pyspark-on-aws-fargate/",
    "datePublished": "2021-01-17T11:30:50.000Z",
    "dateModified": "2021-01-17T11:30:50.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://kapilgarg.github.io/content/images/2021/01/pexels-freestocksorg-457713.jpg"
    },
    "keywords": "pyspark, aws-sdk, hadoop, fargate",
    "description": "I&#x27;m using AWS Batch to run a few pyspark batch jobs and many times, when a job is submitted, it takes a few minutes to start the job. This delay may range from 2-15 minutes depending on the availability of EC2 machine and on the configuration provided. This is something I&#x27;d definitely want to avoid. Recently AWS also started supporting Fargate as computing resource which means if I use Fargate, I can simply specify my requirements (cpu, memory ) and don&#x27;t have to worry about queuing , priority, ",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://kapilgarg.github.io/"
    }
}
    </script>

    <meta name="generator" content="Ghost 5.1" />
    <link rel="alternate" type="application/rss+xml" title="basic function" href="https://kapilgarg.github.io/rss/" />
    <script defer src="https://unpkg.com/@tryghost/portal@~2.1.0/umd/portal.min.js" data-ghost="https://kapilgarg.github.io/" data-key="6411187770ec86e91904481ed3" data-api="https://kapilgarg.github.io/ghost/api/content/" crossorigin="anonymous"></script><style id="gh-members-styles">.gh-post-upgrade-cta-content,
.gh-post-upgrade-cta {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    text-align: center;
    width: 100%;
    color: #ffffff;
    font-size: 16px;
}

.gh-post-upgrade-cta-content {
    border-radius: 8px;
    padding: 40px 4vw;
}

.gh-post-upgrade-cta h2 {
    color: #ffffff;
    font-size: 28px;
    letter-spacing: -0.2px;
    margin: 0;
    padding: 0;
}

.gh-post-upgrade-cta p {
    margin: 20px 0 0;
    padding: 0;
}

.gh-post-upgrade-cta small {
    font-size: 16px;
    letter-spacing: -0.2px;
}

.gh-post-upgrade-cta a {
    color: #ffffff;
    cursor: pointer;
    font-weight: 500;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a:hover {
    color: #ffffff;
    opacity: 0.8;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a.gh-btn {
    display: block;
    background: #ffffff;
    text-decoration: none;
    margin: 28px 0 0;
    padding: 8px 18px;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
}

.gh-post-upgrade-cta a.gh-btn:hover {
    opacity: 0.92;
}</style><style>:root {--ghost-accent-color: #15171A;}</style>
    <!-- link tag -->

</head>
<body class="post-template tag-pyspark tag-aws-sdk tag-hadoop tag-fargate has-cover">
<div class="viewport">

    <header id="gh-head" class="gh-head outer">
        <nav class="gh-head-inner inner">

            <div class="gh-head-brand">
                <a class="gh-head-logo no-image" href="https://kapilgarg.github.io">
                        basic function
                </a>
                <a class="gh-burger" role="button">
                    <div class="gh-burger-box">
                        <div class="gh-burger-inner"></div>
                    </div>
                </a>
            </div>
            <div class="gh-head-menu">
                <ul class="nav">
    <li class="nav-home"><a href="https://kapilgarg.github.io/">Home</a></li>
</ul>

            </div>
            <div class="gh-head-actions">
                <div class="gh-social">
                </div>
                        <a class="gh-head-button" href="#/portal/signup" data-portal="signup">Subscribe</a>
            </div>
        </nav>
    </header>

    <div class="site-content">
        



<main id="site-main" class="site-main">
<article class="article post tag-pyspark tag-aws-sdk tag-hadoop tag-fargate ">

    <header class="article-header gh-canvas">

        <div class="article-tag post-card-tags">
                <span class="post-card-primary-tag">
                    <a href="/tag/pyspark/">pyspark</a>
                </span>
        </div>

        <h1 class="article-title">Pyspark on AWS Fargate</h1>


        <div class="article-byline">
        <section class="article-byline-content">

            <ul class="author-list">
                <li class="author-list-item">
                    <a href="/author/kapil-2/" class="author-avatar author-profile-image"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg>
</a>
                </li>
            </ul>

            <div class="article-byline-meta">
                <h4 class="author-name"><a href="/author/kapil-2/">KAPIL</a></h4>
                <div class="byline-meta-content">
                    <time class="byline-meta-date" datetime="2021-01-17">Jan 17, 2021</time>
                        <span class="byline-reading-time"><span class="bull">&bull;</span> 2 min read</span>
                </div>
            </div>

        </section>
        </div>

            <figure class="article-image">
                <img
                    srcset="/content/images/size/w300/2021/01/pexels-freestocksorg-457713.jpg 300w,
                            /content/images/size/w600/2021/01/pexels-freestocksorg-457713.jpg 600w,
                            /content/images/size/w1000/2021/01/pexels-freestocksorg-457713.jpg 1000w,
                            /content/images/size/w2000/2021/01/pexels-freestocksorg-457713.jpg 2000w"
                    sizes="(min-width: 1400px) 1400px, 92vw"
                    src="/content/images/size/w2000/2021/01/pexels-freestocksorg-457713.jpg"
                    alt="Pyspark on AWS Fargate"
                />
            </figure>

    </header>

    <section class="gh-content gh-canvas">
        <p>I'm using AWS Batch to run a few pyspark batch jobs and many times, when a job is submitted, it takes a few minutes to start the job. This delay may range from 2-15 minutes depending on the availability of EC2 machine and on the configuration provided. This is something I'd definitely want to avoid. Recently AWS also started supporting Fargate as computing resource which means if I use Fargate, I can simply specify my requirements (cpu, memory ) and don't have to worry about queuing , priority, retries etc.</p><p>Fargate requires a bit of different <a href="https://docs.aws.amazon.com/batch/latest/userguide/fargate.html">configuration</a> than AWS batch. We need to provide some additional configuration on compute resource and job definition and some existing configuration for same is not applicable for Fargate. </p><p>If you are running spark 2.4, your existing spark code will throw exception when accessing any of the AWS API like reading from S3/ writing to S3 etc.</p><figure class="kg-card kg-image-card"><img src="https://kapilgarg.github.io/content/images/2021/01/image.png" class="kg-image" alt loading="lazy" width="1112" height="162" srcset="https://kapilgarg.github.io/content/images/size/w600/2021/01/image.png 600w, https://kapilgarg.github.io/content/images/size/w1000/2021/01/image.png 1000w, https://kapilgarg.github.io/content/images/2021/01/image.png 1112w" sizes="(min-width: 720px) 720px"></figure><p>The reason being, spark 2.4 uses AWS SDK 1.7.4 which can not read credentials for Fargate. This SDK version was released before fargate was supported hence it is not able to load the credentials from the IM role that Fargate uses.</p><p>Many versions of this SDK have been released which now supports Fargate but we can not simply use an older version of spark with newer version of AWS SDK. Each version of Hadoop is built with specific version of SDK. In this case, we will have to upgrade spark-hadoop so that it uses a newer version of AWS SDK.</p><p>The latest release of spark is 3.0.1 and  there is a pre built package with Hadoop 3.2. We can use this package to upgrade the spark version and use an updated AWS SDK which is compatible with this spark-hadoop package.</p><p>With this informatin at hand, we can build a docker image and use that with Fargate. While doing so, do not install pyspark using pip. It deploys older version of spark and hadoop which will throw all kinds of errors with newer version of AWS SDK.  Since pyspark is already available with this spark-hadoop package, you just need to provide the location of that to the python and every thing will fall in place.</p><ol><li>There are two ways to do that. If you are not aware of the location,use a python package <em>findspark</em>. import this as a first step in your process and call init on this . This will set up the SPARK_HOME environment variable and python will be able to import pyspark.</li><li>If you are already aware of the path for pyspark, you can directly set that when creating docker image. </li></ol><!--kg-card-begin: html--><script src="https://gist.github.com/kapilgarg/6870c1e8ef1c84551007986d9d71b602.js"></script><!--kg-card-end: html--><p>Thats all required to run your spark job on Fargate.</p><p> ref : </p><ol><li><a href="https://spark.apache.org/downloads.html">Downloads | Apache Spark</a></li><li><a href="https://hadoop.apache.org/docs/r3.2.0/hadoop-project-dist/hadoop-hdfs/dependency-analysis.html">Apache Hadoop 3.2.0 – Dependencies Report</a></li><li><a href="https://aws.amazon.com/blogs/aws/new-fully-serverless-batch-computing-with-aws-batch-support-for-aws-fargate/">https://aws.amazon.com/blogs/aws/new-fully-serverless-batch-computing-with-aws-batch-support-for-aws-fargate/</a></li></ol>
    </section>


</article>
</main>

    <section class="footer-cta outer">
        <div class="inner">
            <h2 class="footer-cta-title">Sign up for more like this.</h2>
            <a class="footer-cta-button" href="#/portal" data-portal>
                <div class="footer-cta-input">Enter your email</div>
                <span>Subscribe</span>
            </a>
        </div>
    </section>



            <aside class="read-more-wrap outer">
                <div class="read-more inner">
                        
<article class="post-card post post-access-public">

    <a class="post-card-image-link" href="/coming-soon/">

        <img class="post-card-image"
            srcset="https://static.ghost.org/v4.0.0/images/feature-image.jpg 300w,
                    https://static.ghost.org/v4.0.0/images/feature-image.jpg 600w,
                    https://static.ghost.org/v4.0.0/images/feature-image.jpg 1000w,
                    https://static.ghost.org/v4.0.0/images/feature-image.jpg 2000w"
            sizes="(max-width: 1000px) 400px, 800px"
            src="https://static.ghost.org/v4.0.0/images/feature-image.jpg"
            alt="Coming soon"
            loading="lazy"
        />


    </a>

    <div class="post-card-content">

        <a class="post-card-content-link" href="/coming-soon/">
            <header class="post-card-header">
                <div class="post-card-tags">
                </div>
                <h2 class="post-card-title">
                    Coming soon
                </h2>
            </header>
                <div class="post-card-excerpt">This is basic function, a brand new site by kapil that's just getting started. Things will be up and running here shortly, but you can subscribe in the meantime if you'd like to stay up to date and receive emails when new content is published!</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2022-05-30">May 30, 2022</time>
        </footer>

    </div>

</article>
                        
<article class="post-card post featured no-image post-access-public">


    <div class="post-card-content">

        <a class="post-card-content-link" href="/mock-environment-variable-in-unittest/">
            <header class="post-card-header">
                <div class="post-card-tags">
                        <span class="post-card-featured"><svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M4.49365 4.58752C3.53115 6.03752 2.74365 7.70002 2.74365 9.25002C2.74365 10.6424 3.29678 11.9778 4.28134 12.9623C5.26591 13.9469 6.60127 14.5 7.99365 14.5C9.38604 14.5 10.7214 13.9469 11.706 12.9623C12.6905 11.9778 13.2437 10.6424 13.2437 9.25002C13.2437 6.00002 10.9937 3.50002 9.16865 1.68127L6.99365 6.25002L4.49365 4.58752Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
</svg> Featured</span>
                </div>
                <h2 class="post-card-title">
                    Mock environment variable in unittest
                </h2>
            </header>
                <div class="post-card-excerpt">While writing test cases, you may need to mock one or more environment variables. It could be because environment variable it used as a flag for certain functionality or something else.

Environment variables are available through os.environ api. Though technically os.environ [1] is not a dictionary but it</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2022-03-08">Mar 8, 2022</time>
                <span class="sep">—</span>
                <span class="post-card-meta-length">2 min read</span>
        </footer>

    </div>

</article>
                        
<article class="post-card post no-image post-access-public">


    <div class="post-card-content">

        <a class="post-card-content-link" href="/write-a-file-watcher-and-read-the-delta/">
            <header class="post-card-header">
                <div class="post-card-tags">
                </div>
                <h2 class="post-card-title">
                    Write a file-watcher and read the delta...
                </h2>
            </header>
                <div class="post-card-excerpt">While working on an on-premise compute grid, there was a need to monitor the status of various jobs running on worker nodes. There is a scheduler which assign tasks to worker nodes and maintains the status of each job. As a job moves through various stages of its life cycle,</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2022-02-20">Feb 20, 2022</time>
                <span class="sep">—</span>
                <span class="post-card-meta-length">1 min read</span>
        </footer>

    </div>

</article>
                </div>
            </aside>



    </div>

    <footer class="site-footer outer">
        <div class="inner">
            <section class="copyright"><a href="https://kapilgarg.github.io">basic function</a> &copy; 2022</section>
            <nav class="site-footer-nav">
                
            </nav>
            <div><a href="https://ghost.org/" target="_blank" rel="noopener">Powered by Ghost</a></div>
        </div>
    </footer>

</div>


<script
    src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous">
</script>
<script src="/assets/built/casper.js?v=776d70e7aa"></script>
<script>
$(document).ready(function () {
    // Mobile Menu Trigger
    $('.gh-burger').click(function () {
        $('body').toggleClass('gh-head-open');
    });
    // FitVids - Makes video embeds responsive
    $(".gh-content").fitVids();
});
</script>

<!-- script tag -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-169335725-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-169335725-1');
</script>

</body>
</html>
